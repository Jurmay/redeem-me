<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Poker Table – Player</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top, #003b25, #00130f 60%, #000000 100%);
            color: #f5f5f5;
        }
        .top-bar {
            padding: 16px;
            text-align: center;
        }
        h1 {
            margin: 8px 0 16px;
        }
        input[type="text"] {
            padding: 6px 8px;
            margin-right: 6px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #0e2b23;
            color: #f5f5f5;
        }
        button {
            padding: 6px 14px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        #join-btn {
            background-color: #1e8c3a;
            color: #fff;
        }

        .table-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 8px;
        }
        .table-outer {
            width: 700px;
            height: 370px;
            border-radius: 50%;
            border: 6px solid #a35a2a;
            background: radial-gradient(circle at top, #13542f, #06321a 65%, #04180f);
            position: relative;
        }

        .seat {
            position: absolute;
            width: 130px;
            padding: 6px 8px;
            background: #020b0a;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            font-size: 12px;
            text-align: left;
            border: 1px solid transparent;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .seat.to-act {
            box-shadow: 0 0 12px rgba(255,215,0,0.9);
            border-color: #ffd700;
        }
        .seat-title {
            font-weight: 700;
            display: block;
        }
        .seat-line {
            font-size: 11px;
            opacity: 0.85;
        }
        .seat-cards {
            margin-top: 2px;
            display: flex;
            gap: 2px;
        }
        .card-back-mini {
            width: 22px;
            height: 30px;
            border-radius: 4px;
            background-image: url("/static/cards_renamed/back.png");
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
        }

        /* Seat positions – 7 seats around the oval */
        #seat-0 { top: 22px;  left: 50%; transform: translateX(-50%); }
        #seat-1 { top: 70px;  left: 90px; }
        #seat-2 { top: 70px;  right: 90px; }
        #seat-3 { top: 170px; right: 35px; }
        #seat-4 { bottom: 55px; right: 110px; }
        #seat-5 { bottom: 55px; left: 110px; }
        #seat-6 { top: 170px; left: 35px; }

        .board-row {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 8px;
        }
        .board-card {
            width: 60px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid #1d3d32;
            background: linear-gradient(135deg, #0f2720, #16382d);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 8px rgba(0,0,0,0.7);
            font-size: 20px;
            font-weight: 700;
            overflow: hidden;
        }
        .center-info {
            position: absolute;
            top: 58%;
            left: 50%;
            transform: translate(-50%, 0);
            text-align: center;
            font-size: 12px;
        }

        .bottom-panel {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .player-panel {
            width: 700px;
            background: #040f0d;
            border-radius: 10px;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            padding: 10px 14px;
            font-size: 13px;
        }
        .panel-title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        .panel-line {
            margin: 2px 0;
        }
        .actions-row {
            margin-top: 6px;
        }
        .actions-row button {
            margin-right: 4px;
        }
        .actions-row input {
            width: 60px;
        }

        .card-img {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            display: block;
        }
        .deal-anim {
            animation: dealIn 0.25s ease-out;
        }
        @keyframes dealIn {
            from {
                transform: translateY(-20px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 900px) {
            .player-panel {
                width: 90%;
            }
        }
        @media (max-width: 600px) {
            .top-bar {
                padding: 8px;
                font-size: 12px;
            }
            h1 {
                font-size: 18px;
            }
            .player-panel {
                width: 95%;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Poker Table – Player</h1>
        <input type="text" id="name-input" placeholder="Your name" />
        <button id="join-btn">Join Table</button>
        <span id="join-status"></span>
    </div>

    <div class="table-wrapper">
        <div class="table-outer">
            <div class="seat" id="seat-0">
                <span class="seat-title">Hero AI</span>
                <span class="seat-line" id="seat-0-line">Chips: –</span>
                <div class="seat-cards" id="seat-0-cards"></div>
            </div>
            <div class="seat" id="seat-1">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-1-line">–</span>
                <div class="seat-cards" id="seat-1-cards"></div>
            </div>
            <div class="seat" id="seat-2">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-2-line">–</span>
                <div class="seat-cards" id="seat-2-cards"></div>
            </div>
            <div class="seat" id="seat-3">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-3-line">–</span>
                <div class="seat-cards" id="seat-3-cards"></div>
            </div>
            <div class="seat" id="seat-4">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-4-line">–</span>
                <div class="seat-cards" id="seat-4-cards"></div>
            </div>
            <div class="seat" id="seat-5">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-5-line">–</span>
                <div class="seat-cards" id="seat-5-cards"></div>
            </div>
            <div class="seat" id="seat-6">
                <span class="seat-title">Empty</span>
                <span class="seat-line" id="seat-6-line">–</span>
                <div class="seat-cards" id="seat-6-cards"></div>
            </div>

            <div class="board-row">
                <div class="board-card" id="board-0">?</div>
                <div class="board-card" id="board-1">?</div>
                <div class="board-card" id="board-2">?</div>
                <div class="board-card" id="board-3">?</div>
                <div class="board-card" id="board-4">?</div>
            </div>
            <div class="center-info">
                <div>Pot: <span id="pot-text">0</span></div>
                <div>Street: <span id="street-text">-</span></div>
            </div>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="player-panel">
            <div class="panel-title">Seat Info</div>
            <div class="panel-line">Seat: <span id="seat-text">-</span></div>
            <div class="panel-line">Your cards: <span id="hole-cards-text">-</span></div>
            <div class="panel-line">To call: <span id="to-call-text">0</span></div>

            <div class="actions-row">
                <button id="fold-btn">Fold</button>
                <button id="check-btn">Check</button>
                <button id="call-btn">Call</button>
                <input type="number" id="raise-amount" value="20" min="1" />
                <button id="raise-btn">Raise</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        let mySeat = null;
        let toCall = 0;

        const TABLE_BASE_WIDTH = 700;
        function updateTableScale() {
            const table = document.querySelector(".table-outer");
            if (!table) return;
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const dpr = window.devicePixelRatio || 1;
            const usableWidth = viewportWidth * 0.95;
            let scale = usableWidth / TABLE_BASE_WIDTH;
            if (scale > 1) scale = 1;
            if (dpr >= 2) {
                scale *= 1.05;
                if (scale > 1) scale = 1;
            }
            table.style.transform = `scale(${scale})`;
            table.style.transformOrigin = "top center";
        }
        window.addEventListener("load", updateTableScale);
        window.addEventListener("resize", updateTableScale);

        function cardImageUrl(code) {
            if (!code || code.length < 2) return null;
            return `/static/cards_renamed/${code}.png`;
        }

        function updateBoard(board) {
            for (let i = 0; i < 5; i++) {
                const el = document.getElementById("board-" + i);
                const card = board && board[i] ? board[i] : null;
                if (!card) {
                    el.innerHTML = "?";
                } else {
                    const url = cardImageUrl(card);
                    el.innerHTML = `<img src="${url}" class="card-img deal-anim">`;
                }
            }
        }

        function updateSeats(players, currentSeat, handRunning) {
            const defaults = [
                { seat: 0, title: "Hero AI" },
                { seat: 1, title: "Empty" },
                { seat: 2, title: "Empty" },
                { seat: 3, title: "Empty" },
                { seat: 4, title: "Empty" },
                { seat: 5, title: "Empty" },
                { seat: 6, title: "Empty" }
            ];

            defaults.forEach(d => {
                const box = document.getElementById("seat-" + d.seat);
                const line = document.getElementById("seat-" + d.seat + "-line");
                const cards = document.getElementById("seat-" + d.seat + "-cards");
                if (!box || !line) return;
                box.querySelector(".seat-title").textContent = d.title;
                box.classList.remove("to-act");
                line.textContent = (d.seat === 0) ? "Chips: –" : "–";
                if (cards) cards.innerHTML = "";
            });

            const list = Array.isArray(players) ? players : [];
            list.forEach(p => {
                const box = document.getElementById("seat-" + p.seat);
                const line = document.getElementById("seat-" + p.seat + "-line");
                const cards = document.getElementById("seat-" + p.seat + "-cards");
                if (!box || !line) return;

                box.querySelector(".seat-title").textContent = p.name || ("Seat " + p.seat);
                let txt = "Chips: " + (p.chips ?? "-");
                if (p.folded) txt += " (folded)";
                if (currentSeat === p.seat) txt += " – To act";
                line.textContent = txt;

                if (currentSeat === p.seat) {
                    box.classList.add("to-act");
                }

                if (cards) {
                    if (handRunning && !p.folded) {
                        cards.innerHTML = `
                            <div class="card-back-mini"></div>
                            <div class="card-back-mini"></div>
                        `;
                    } else {
                        cards.innerHTML = "";
                    }
                }
            });
        }

        document.getElementById("join-btn").addEventListener("click", () => {
            const name = document.getElementById("name-input").value.trim() || "Guest";
            socket.emit("join_table", { name });
        });

        socket.on("join_result", data => {
            if (!data.success) {
                document.getElementById("join-status").textContent = "Table full";
                return;
            }
            mySeat = data.seat;
            document.getElementById("seat-text").textContent = mySeat;
            document.getElementById("join-status").textContent = "Joined as seat " + mySeat;
        });

        socket.on("table_state", data => {
            document.getElementById("pot-text").textContent = data.pot ?? 0;
            document.getElementById("street-text").textContent = data.street || "-";
            updateBoard(data.board || []);
            updateSeats(data.players || [], data.current_player_seat, data.hand_running);
        });

        socket.on("hole_cards", data => {
            const cards = data.cards || [];
            const html = cards.map(c =>
                `<img src="${cardImageUrl(c)}" style="width:45px;height:65px;border-radius:6px;margin-right:4px;" class="deal-anim">`
            ).join("");
            document.getElementById("hole-cards-text").innerHTML = html || "-";
        });

        socket.on("request_action", data => {
            if (data.seat !== mySeat) return;
            toCall = data.to_call || 0;
            document.getElementById("to-call-text").textContent = toCall;
        });

        function sendAction(action, amount) {
            if (mySeat === null) return;
            socket.emit("player_action", {
                seat: mySeat,
                action: action,
                amount: amount || 0
            });
        }

        document.getElementById("fold-btn").addEventListener("click", () => {
            sendAction("FOLD", 0);
        });
        document.getElementById("check-btn").addEventListener("click", () => {
            sendAction("CHECK", 0);
        });
        document.getElementById("call-btn").addEventListener("click", () => {
            sendAction("CALL", toCall);
        });
        document.getElementById("raise-btn").addEventListener("click", () => {
            const amt = parseInt(document.getElementById("raise-amount").value || "0", 10);
            if (amt > 0) sendAction("RAISE", amt);
        });
    </script>
</body>
</html>
